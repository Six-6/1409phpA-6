(function($){var TopSummary=function(cfg){this.cfg=cfg;this.init();this.bindEvents();}
TopSummary.prototype={init:function(){$.extend(this,this.cfg);this.topList=this.elt.find("dd");this.topType=this.elt.find(".top_type");},bindEvents:function(){this.topType.on("change","select",$.proxy(this.onDepartCityChange,this));this.topList.on("click",".top_type .spot_tags li:not(.sep)",$.proxy(this.onSpotTagSelect,this));},onSpotTagSelect:function(e){var target=$(e.currentTarget),container=$(target).parents("dd"),topType=$(container).find(".top_type");$(target).addClass("selected");$(target).siblings("li:not(.sep)").removeClass("selected");var poiId=$(target).attr("data-id"),departCityCode=topType.find("select").val();var self=this,promise=this.queryTopDetail(poiId);promise.then(function(data){if(data){var select=$(container).find(".top_type select"),topList=$(container).find(".top_list2"),topMore=$(container).find(".top_more a");self.renderDepartCityList(select,data.departCityList);self.renderRouteList(topList,data.routes);var departCityCodeNew=$(select).val();$(topMore).attr("href","/line/detail-"+poiId+"-"+departCityCodeNew+"-0/");}});},onDepartCityChange:function(e){var target=$(e.target),container=$(target).parents("dd");var poiId,topType=container.find(".top_type");if(topType.find(".spot_tags li").length>0){poiId=topType.find(".spot_tags li.selected").attr("data-id");}else{poiId=topType.find(".spot_tags").attr("data-id");}
var departCityCode=topType.find("select").val();var self=this,promise=this.queryTopDetail(poiId,departCityCode);promise.then(function(data){if(data){var select=$(container).find(".top_type select"),topList=$(container).find(".top_list2");topMore=$(container).find(".top_more a");$(topMore).attr("href","/line/detail-"+poiId+"-"+departCityCode+"-0/");self.renderRouteList(topList,data.routes);}});},renderDepartCityList:function(select,list){select.empty();$.each(list,function(idx,item){$("<option></option>").attr("value",item.id).text(item.name).appendTo(select);});},renderRouteList:function(topList,list){var html=template("topListTemplate",{routes:list});$(topList).hide();$(topList).html(html);$(topList).fadeIn(300);},queryTopDetail:function(poiId,departCityCode){var promise=$.ajax({url:"/yii.php?r=signal/api/DepartureCityRoute",dataType:"jsonp",jsonp:"callback",data:{poiId:poiId,departCityCode:departCityCode}});return promise;}}
$(function(){new TopSummary({elt:$(".top_summary")});});})(jQuery);